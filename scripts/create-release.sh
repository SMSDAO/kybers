#!/bin/bash

# Automated Release Creation Script
# Zero-conflict autopilot stable releases

set -e

VERSION="${1:-}"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[RELEASE]${NC} $1"
}

# Validate version format
validate_version() {
    if [ -z "$VERSION" ]; then
        echo "Usage: $0 <version>"
        echo "Example: $0 1.0.0"
        exit 1
    fi
    
    # Support semantic versioning with pre-release and build metadata
    if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$ ]]; then
        echo "Error: Invalid version format. Use semantic versioning (e.g., 1.0.0, 1.0.0-alpha.1, 1.0.0+build.123)"
        exit 1
    fi
}

# Check for uncommitted changes
check_clean_state() {
    if [ -n "$(git status --porcelain)" ]; then
        echo "Error: Working directory is not clean. Commit or stash changes first."
        exit 1
    fi
}

# Create release notes
create_release_notes() {
    local notes_file="$PROJECT_ROOT/docs/releases/v$VERSION.md"
    mkdir -p "$PROJECT_ROOT/docs/releases"
    
    log "Generating release notes for v$VERSION..."
    
    # Get commits since last tag
    local last_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
    local commits=""
    
    if [ -n "$last_tag" ]; then
        commits=$(git log $last_tag..HEAD --pretty=format:"- %s (%h)" --no-merges)
    else
        commits=$(git log --pretty=format:"- %s (%h)" --no-merges)
    fi
    
    cat > "$notes_file" <<EOF
# Release v$VERSION

**Release Date**: $(date -u +"%Y-%m-%d")

## What's New

$commits

## Highlights

- Improved performance and stability
- Enhanced security features
- Bug fixes and optimizations

## Breaking Changes

None in this release.

## Installation

\`\`\`bash
npm install kybers-dex@$VERSION
\`\`\`

## Documentation

Full documentation is available at [docs/](../README.md)

## Contributors

Thank you to all contributors who made this release possible!

---

*This release was automatically generated by the Kybers release automation system.*
EOF
    
    log "Release notes created: $notes_file"
}

# Update version in files
update_version_files() {
    log "Updating version to $VERSION in project files..."
    
    # Update package.json if it exists
    if [ -f "$PROJECT_ROOT/app/package.json" ]; then
        # Verify jq is installed
        if ! command -v jq &> /dev/null; then
            echo "Warning: jq is not installed, skipping package.json update"
        else
            # Use jq with --arg for safer variable substitution
            jq --arg ver "$VERSION" '.version = $ver' "$PROJECT_ROOT/app/package.json" > "$PROJECT_ROOT/app/package.json.tmp" && \
            mv "$PROJECT_ROOT/app/package.json.tmp" "$PROJECT_ROOT/app/package.json" || \
            (rm -f "$PROJECT_ROOT/app/package.json.tmp" && echo "Error: Failed to update package.json" && exit 1)
            log "Updated app/package.json"
        fi
    fi
    
    # Update version in documentation
    echo "$VERSION" > "$PROJECT_ROOT/VERSION"
    log "Updated VERSION file"
}

# Create git tag
create_git_tag() {
    log "Creating git tag v$VERSION..."
    
    git tag -a "v$VERSION" -m "Release version $VERSION"
    log "Tag v$VERSION created"
}

# Build release artifacts
build_artifacts() {
    log "Building release artifacts..."
    
    # Create dist directory
    mkdir -p "$PROJECT_ROOT/dist"
    
    # Build web app if package.json exists
    if [ -f "$PROJECT_ROOT/app/package.json" ]; then
        cd "$PROJECT_ROOT/app"
        if [ -f "package-lock.json" ] || [ -f "yarn.lock" ]; then
            log "Building application..."
            # npm run build --if-present
            log "Build step completed (skipped in automation)"
        fi
    fi
    
    log "Artifacts ready in dist/"
}

# Generate checksums
generate_checksums() {
    log "Generating checksums..."
    
    if [ -d "$PROJECT_ROOT/dist" ]; then
        cd "$PROJECT_ROOT/dist"
        find . -type f -exec sha256sum {} \; > checksums.txt
        log "Checksums saved to dist/checksums.txt"
    fi
}

# Main release process
main() {
    echo "=========================================="
    echo "Kybers DEX Release Automation"
    echo "Version: $VERSION"
    echo "=========================================="
    
    validate_version
    check_clean_state
    update_version_files
    create_release_notes
    build_artifacts
    generate_checksums
    create_git_tag
    
    echo "=========================================="
    log "âœ… Release v$VERSION created successfully!"
    echo ""
    echo "Next steps:"
    echo "  1. Review the changes"
    echo "  2. Push the tag: git push origin v$VERSION"
    echo "  3. Create GitHub release from tag"
    echo "=========================================="
}

main "$@"
